blueprint:
  name: Motion Light Switch (with daylight & self-healing timeout)
  description: |
    Turns lights on when motion is detected and off when no motion after delay.
    Adds optional daylight sensor (skip lighting if bright) and a self-healing
    timeout that turns lights off if they remain on for too long with no motion.
  domain: automation

  input:
    motion_sensor:
      name: Motion Sensor(s)
      selector:
        entity:
          domain: binary_sensor
          multiple: true
    target_lights:
      name: Lights to Control
      selector:
        target:
          entity:
            domain: light
    no_motion_wait:
      name: Delay before turning off (seconds)
      default: 60
      selector:
        number:
          min: 10
          max: 600
          unit_of_measurement: seconds
          mode: slider
    night_mode:
      name: Night Mode Boolean (optional)
      default: input_boolean.night_mode
      selector:
        entity:
          domain: input_boolean
          multiple: false
    daylight_sensor:
      name: Daylight Sensor (optional)
      description: Prevents lights from turning on if daylight is detected (state == 'on')
      default: binary_sensor.daylight
      selector:
        entity:
          domain: binary_sensor
          multiple: false
    daylight_block_enabled:
      name: Skip light-on if daylight is active
      default: true
      selector:
        boolean: {}
    brightness_day:
      name: Brightness when not in night mode
      default: 255
      selector:
        number:
          min: 1
          max: 255
    brightness_night:
      name: Brightness when in night mode
      default: 60
      selector:
        number:
          min: 1
          max: 255
    light_on_timeout:
      name: Light-on Timeout (minutes)
      description: Maximum time a light can stay on before itâ€™s re-evaluated for shutdown.
      default: 5
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: minutes
          mode: slider

mode: restart

variables:
  daylight_sensor_var: !input daylight_sensor
  daylight_block_enabled_var: !input daylight_block_enabled
  motion_sensors_var: !input motion_sensor
  target_lights_var: !input target_lights
  light_on_timeout_var: !input light_on_timeout

trigger:
  # Motion ON/OFF triggers
  - platform: state
    entity_id: !input motion_sensor
    to: 'on'
  - platform: state
    entity_id: !input motion_sensor
    to: 'off'
    for:
      seconds: !input no_motion_wait

  # Self-healing timeout trigger
  - platform: time_pattern
    minutes: "/1"  # check every minute

condition:
  - condition: template
    value_template: "{{ true }}"  # always allow, we evaluate logic in action

action:
  - variables:
      lights_on_too_long: >-
        {% set threshold = light_on_timeout_var | int * 60 %}
        {% set now_ts = as_timestamp(now()) %}
        {% set lights = expand(target_lights_var.entity_id | default([])) %}
        {% for light in lights %}
          {% if light.state == 'on' and (now_ts - as_timestamp(light.last_changed)) > threshold %}
            {{ true }}
          {% endif %}
        {% endfor %}
        false

  - choose:
      # --- Motion detected ---
      - conditions:
          - condition: state
            entity_id: !input motion_sensor
            state: 'on'
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ not daylight_sensor_var }}"
              - condition: template
                value_template: "{{ not daylight_block_enabled_var }}"
              - condition: template
                value_template: >
                  {{ daylight_sensor_var and states(daylight_sensor_var) in ['off','unknown','unavailable'] }}
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input night_mode
                    state: 'on'
                sequence:
                  - service: light.turn_on
                    data:
                      brightness: !input brightness_night
                    target: !input target_lights
              - conditions:
                  - condition: state
                    entity_id: !input night_mode
                    state: 'off'
                sequence:
                  - service: light.turn_on
                    data:
                      brightness: !input brightness_day
                    target: !input target_lights

      # --- Motion cleared ---
      - conditions:
          - condition: state
            entity_id: !input motion_sensor
            state: 'off'
        sequence:
          - service: light.turn_off
            target: !input target_lights

      # --- Timeout recheck ---
      - conditions:
          - condition: template
            value_template: "{{ lights_on_too_long | trim == 'true' }}"
          - condition: template
            value_template: >
              {% set motions = expand(motion_sensors_var | default([])) | selectattr('state','eq','on') | list %}
              {{ motions | count == 0 }}
        sequence:
          - service: light.turn_off
            target: !input target_lights
