blueprint:
  name: Open shutters if daylight
  description: >
    Automatically opens shutters when daylight is detected or when lights have
    been on for more than 30 seconds. Supports extra user-defined conditions.
  domain: automation

  input:
    lights:
      name: Lights
      description: Lights or switches that will trigger and later be turned off.
      selector:
        entity:
          multiple: true
          domain:
            - light
            - switch

    shutters:
      name: Shutters
      description: Shutters to open when conditions are met.
      selector:
        entity:
          multiple: true
          domain: cover

    daylight_sensor:
      name: Daylight sensor
      description: Binary sensor indicating daylight.
      selector:
        entity:
          domain: binary_sensor

    extra_conditions:
      name: Extra conditions (optional)
      description: >
        Add additional conditions that must be true for the shutters to open.
      default: []
      selector:
        condition: {}

variables:
  light_entities: !input lights

trigger:
  - platform: state
    entity_id: !input daylight_sensor
    from: "off"
    to: "on"
    for:
      minutes: 1
    alias: "Daylight detected for 1 minute"

  - platform: state
    entity_id: !input lights
    to: "on"
    for:
      seconds: 30
    alias: "Light(s) on for 30 seconds"

condition:
  - condition: template
    alias: "At least one light on"
    value_template: >
      {{ expand(light_entities)
         | selectattr('state', 'eq', 'on')
         | list
         | count > 0 }}

  - condition: and
    conditions: !input extra_conditions
    alias: "User-defined extra conditions"

action:
  - alias: "Open shutters"
    service: cover.open_cover
    target:
      entity_id: !input shutters

  - delay:
      seconds: 10

  - alias: "Turn off triggering lights"
    service: homeassistant.turn_off
    target:
      entity_id: !input lights

mode: single
